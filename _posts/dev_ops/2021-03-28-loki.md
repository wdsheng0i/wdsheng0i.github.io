---
layout: post
title: PLG(Promtail + Loki + Grafana) 
category: dev-ops
tags: [dev-ops]
---

日志平台：PLG(Promtail + Loki + Grafana)

## 参考资料
- Loki: https://grafana.com/docs/loki/latest/installation/
  - https://grafana.com/docs/loki/latest/configuration/
- Promtail：https://grafana.com/docs/loki/latest/clients/promtail/installation/
- Grafana：https://grafana.com/docs/grafana/latest/setup-grafana/installation/
- 配置说明：https://www.mianshigee.com/tutorial/loki/readme.md
- Grafana+Loki+Promtail 搭建日志收集系统:https://blog.csdn.net/jilo88/article/details/131241264
- PLG（Promtail + Loki + Grafana）日志系统生产快速实践:https://blog.csdn.net/AndCo/article/details/128949093

## 前言 
Loki索引是由标签建立的,原始日志消息不被索引，采用计算换空间的方式，  
Loki特点：通过对日志索引，高效使用内存  
多租户：读写链接的多租户实现   
可扩展性: 可使用all in one 部署，即所有组件均在同一进程内; 每一个loki组件都能以微服务形式运行，配置允许单独扩展微服务，允许灵活的大规模安装。  
易用性：拥有大量的可观测性的客户端插件支持，例如支持promtail、fluentd等  
Loki与Grafana无缝集成，提供了一个完整的可观察性堆栈。  

## 一、PLG日志系统介绍
- Promtail： 日志采集器，安装部署在需要收集和分析日志的业务服务器，promtail会将日志发给Loki服务。
- Loki： 主服务器，负责存储日志和处理查询。由Grafana提供的开源日志聚合工具，一个高效存储日志数据的数据存储
- Grafana：提供web管理界面，数据搜索展示功能。

![](../../assets/images/2021/devops/loki.png)  
- promtail收集并将日志发送给loki的 Distributor 组件
- Distributor会对接收到的日志流进行正确性校验，并将验证后的日志分批并行发送到Ingester
- Ingester 接受日志流并构建数据块，压缩后存放到所连接的存储后端
- Querier 收到HTTP查询请求，并将请求发送至Ingester 用以获取内存数据 ，Ingester 收到请求后返回符合条件的数据 ；
如果 Ingester 没有返回数据，Querier 会从后端存储加载数据并遍历去重执行查询 ，通过HTTP返回查询结果

## 二、单例部署应用
loki、promtail 离线包下载（选择同一版本下）：https://github.com/grafana/loki/releases/
Grafana 下载地址：https://grafana.com/grafana/download?platform=linux

### 2.1 loki部署 
``` 
# 1、下载zip、解压
curl -O -L "https://github.com/grafana/loki/releases/download/v2.8.4/loki-linux-amd64.zip"
或者
wget https://github.com/grafana/loki/releases/download/v2.7.1/loki-linux-amd64.zip
unzip "loki-linux-amd64.zip"
chmod a+x "loki-linux-amd64"

# 2、下载配置loki-config.yaml
wget https://raw.githubusercontent.com/grafana/loki/master/cmd/loki/loki-local-config.yaml

# 3、修改配置loki-config.yaml
auth_enabled: false
server:
  http_listen_port: 3100  # http 端口
  grpc_listen_port: 9096
common:
  path_prefix: /data/loki
  storage:
    filesystem:  # loki 存储位置
      chunks_directory: /data/loki/chunks
      rules_directory: /data/loki/rules
  replication_factor: 1
  ring:
    instance_addr: 127.0.0.1
    kvstore:
      store: inmemory
query_range:
  results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 100
compactor:
  working_directory: /data/loki/compactor      # 压缩目录，一般也作为持久化目录
  compaction_interval: 10m                 # 压缩间隔
  retention_enabled: true                  # 持久化开启
  retention_delete_delay: 2h               # 过期后多久删除
  retention_delete_worker_count: 150       # 过期删除协程数目
schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h  
ruler:
  alertmanager_url: http://localhost:9093
limits_config:
  reject_old_samples: true   # 是否拒绝旧样本
  reject_old_samples_max_age: 168h   # 168小时之前的样本被拒绝
chunk_store_config:
  max_look_back_period: 168h  # 为避免查询超过保留期的数据，必须小于或等于下方的时间值
table_manager:
  retention_deletes_enabled: true   # 保留删除开启
  retention_period: 168h  # 超过168h的块数据将被删除，必须为24h的倍数

# 4、后台启动nohup
nohup ./loki-linux-amd64 -config.file=loki-local-config.yaml &
nohup ./loki-linux-amd64 -config.file=loki-local-config.yaml > /opt/logs/loki-3100.log 2>&1 &
如需debug日志，使用以下启动命令：
nohup ./loki-linux-amd64 -config.file=loki-local-config.yaml --log.level=debug > /opt/logs/loki-3100.log 2>&1 &

# 或者配置服务启动
cat > /etc/systemd/system/loki.service <<EOF
[Unit]
Description=loki
After=network.target 

[Service]
ExecStart=/opt/loki/loki-linux-amd64 \
	-config.file=/opt/loki/loki-local-config.yaml &>> /opt/logs/loki-3100.log
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF 

# 启动服务，设置开机自启，并检查服务开启状态
systemctl daemon-reload
systemctl start loki
systemctl status loki
systemctl enable loki
```

### 2.2 promtail部署
``` 
# 1、下载zip、解压
curl -O -L "https://github.com/grafana/loki/releases/download/v2.8.4/promtail-linux-amd64.zip"
或者
wget https://github.com/grafana/loki/releases/download/v2.2.1/promtail-linux-amd64.zip
unzip "promtail-linux-amd64.zip"
chmod a+x "promtail-linux-amd64"

# 2、下载配置loki-config.yaml
wget https://raw.githubusercontent.com/grafana/loki/main/clients/cmd/promtail/promtail-local-config.yaml

# 3、修改配置promtail-local-config.yaml
Promtail 配置文件说明：https://blog.csdn.net/JineD/article/details/127092849
server:
  http_listen_port: 9080
  grpc_listen_port: 0
positions:
  filename: /tmp/positions.yaml
clients:
  - url: http://10.0.0.32:3100/loki/api/v1/push  # 推送到loki地址 
scrape_configs:
- job_name: logs  # 唯一
  static_configs:
  - targets:
      - localhost  # 读取本地文件
    labels: # labels 用户loki labels查询
      job: admin-service
      __path__: /data/logs/admin-service/*/*info.log  # 读取后缀为info.log的日志文件
  - targets:
      - localhost  
    labels: 
      job: gateway-service
      __path__: /data/logs/gateway-service/*/*info.log 

# 4、后台启动nohup
nohup ./promtail-linux-amd64 -config.file=promtail-config.yaml &
nohup ./promtail-linux-amd64 -config.file=promtail-local-config.yaml > /opt/logs/promtail-9080.log 2>&1 &

# 或者配置系统服务启动
# cat > /etc/systemd/system/promtail.service <<EOF
[Unit]
Description=promtail
After=network.target 

[Service]
ExecStart=/opt/loki/promtail-linux-amd64 \
	-config.file=/opt/loki/promtail-local-config.yaml &>> /opt/logs/promtail-9080.log
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# 启动服务，设置开机自启，并检查服务开启状态
 systemctl daemon-reload
 systemctl start promtail
 systemctl status promtail
 systemctl enable promtail
```

### 2.3 grafana部署 
1.通过rpm安装
```
1).下载安装
sudo yum install -y https://dl.grafana.com/enterprise/release/grafana-enterprise-10.0.0-1.x86_64.rpm
或者
wget https://dl.grafana.com/enterprise/release/grafana-enterprise-10.0.0-1.x86_64.rpm
sudo yum localinstall grafana-4.6.1-1.x86_64.rpm

2).启动
service grafana-server start
加入开机启动
/sbin/chkconfig --add grafana-server

3)、配置 
修改端口，如果我们是通过yum 方式按照rpm包的话，此时可以通过 
vi  usr/share/grafana/conf/defaults.ini
对于其他文件如下
# init.d脚本
/etc/init.d/grafana-server
# 安装默认环境变量文件
/etc/sysconfig/grafana-server
# 配置文件，修改这个文件不起作用。
/etc/grafana/grafana.ini
# 日志文件
/var/log/grafana/grafana.log
# 默认sqlite3数据库 
```

2.通过tar包安装 (推荐)
``` 
1)、下载解压
wget https://dl.grafana.com/enterprise/release/grafana-enterprise-10.0.0.linux-amd64.tar.gz
tar -zxvf grafana-enterprise-10.0.0.linux-amd64.tar.gz

2)、启动 
后台启动
nohup ./bin/grafana-server > /opt/logs/grafana.log 2>&1 &

添加启动服务
vim /usr/lib/systemd/system/grafana-server.service

[Unit]
Description=Grafana
After=network.target

[Service]
Type=notify
ExecStart=/opt/grafana/bin/grafana-server -homepath /opt/grafana
Restart=on-failure

[Install]
WantedBy=multi-user.target 
```

- gtafana：http://ip:3000/ 默认端口3000，默认账号 admin/admin, 首次登录修改密码
- loki：http://ip:3100/ grafana中配置datasource，添加loki地址即可

## 三、容器化高可用集群部署


## 四、Q & A