---
layout: post
title: apollo
category: dev-ops
tags: [dev-ops]
---

apollo配置中心

## 参考资料
- [apollo介绍-github](https://github.com/ctripcorp/apollo/wiki)
- [官方文档](https://www.apolloconfig.com/#/zh/design/apollo-introduction)

## 一、apollo部署 
[分布式部署指南](https://www.apolloconfig.com/#/zh/deployment/distributed-deployment-guide)

【组件部署】Apollo
![](https://wdsheng0i.github.io/assets/images/2021/apollo/apollo.png)

``` 
安装包：https://github.com/apolloconfig/apollo/releases  

主机规划
192.168.145.1 apollo-portal apollo-config  
192.168.145.2 apollo-admin apollo-config  

1、导入数据库初始化文件（此sql已包含创建数据库的步骤）
MySQL > source /your_local_path/apolloconfigdb.sql
MySQL > source /your_local_path/apolloportaldb.sql

2、配置Eureka
UPDATE `ApolloConfigDB`.`ServerConfig` 
SET `Value` = 'http://testuser:1qaz@WSX@192.168.145.1:11000/eureka/,
http://testuser:1qaz@WSX@192.168.145.2:11000/eureka/'
WHERE `Key` = 'eureka.service.url';

3、配置环境列表与组织名称
UPDATE `ApolloPortalDB`.`ServerConfig` 
SET `Value` = 'pro' 
WHERE `Key` = 'apollo.portal.envs';
UPDATE `ApolloPortalDB`.`ServerConfig` 
SET `Value` = '[{"orgId":"WDSSOFT","orgName":""}]' 
WHERE `Key` = 'organizations';
 
4、配置数据库连接文件
# apollo-adminservice/config/application-github.properties
# apollo-configservice/config/application-github.properties
spring.datasource.url = jdbc:mysql://192.168.145.1:3306/apolloconfigdb?
characterEncoding=utf8&useLocalSessionState=true
spring.datasource.username = user
spring.datasource.password = password

# apollo-portal/config/application-github.properties
spring.datasource.url = jdbc:mysql://192.168.145.1/apolloportaldb?
characterEncoding=utf8&useLocalSessionState=true
spring.datasource.username = user
spring.datasource.password = password

5、配置环境的meta server地址
# apollo-portal/config/apollo-env.properties
lpt.meta=${lpt_meta}
pro.meta=http://192.168.145.1:9000,http://192.168.145.2:9000

6、修改apollo-admin、apollo-config的Eureka注册id
# apollo-config/scripts/startup.sh
# apollo-admin/scripts/startup.sh
export JAVA_OPTS="$JAVA_OPTS -Deureka.instance.instance-id=192.168.145.1:$SERVER_PORT ......

7、配置日志位置
# apollo-config/scripts/startup.sh
# apollo-admin/scripts/startup.sh
# apollo-portal/scripts/startup.sh
## Adjust log dir if necessary
LOG_DIR=./logs/100003172

8、依次启动apollo-config、apollo-admin、apollo-portal
/bin/bash apollo-config/scripts/startup.sh
/bin/bash apollo-admin/scripts/startup.sh
/bin/bash apollo-portal/scripts/startup.sh
```